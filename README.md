
# SQLcl Snapshot Fixer

## Purpose

This script is designed to address specific issues found in the output of the Oracle SQLcl `project export` command (as of version 25.2.2). Its primary functions are:

1.  **Fixing Missing `IDENTITY_COLUMN` Tags**: It automatically detects and corrects malformed SXML metadata where the closing `</IDENTITY_COLUMN>` tag is missing. It inserts the complete, required block of identity-related tags.
2.  **Validating Column Consistency**: After any corrections, it compares the list of columns in the `CREATE TABLE` DDL statement against the columns listed in the SXML metadata. This helps identify any columns that might have been missed by the `sqlcl` export process.

---

## Important: Specific `IDENTITY` Clause

This script is highly specific and has been tailored to fix a particular type of `IDENTITY_COLUMN` definition. It is designed to work with the following clause:

```sql
GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE NOKEEP NOSCALE NOT NULL ENABLE
````

If your `IDENTITY` clause differs from this (e.g., different `START WITH` values, `GENERATED ALWAYS`, etc.), you will need to **modify the Python script** to match your specific DDL. The logic for adding the new tags is contained within the `process_single_file` function.

-----

## How It Works

The script will:

  - Traverse a specified folder and all its subfolders, looking for `.sql` files.
  - Read each file and check for a `-- sqlcl_snapshot` line.
  - Attempt to fix any malformed `IDENTITY_COLUMN` sections within the SXML.
  - Compare the columns in the SQL DDL with the columns in the SXML metadata.

### Log File Generation

If the script finds any discrepancies between the DDL columns and the SXML columns, it will create a new file with a `.log` extension in the same directory (e.g., `my_table.sql` will generate `my_table.log`).

The purpose of this log file is to provide a clear, human-readable view for manual comparison. It contains:

  - A summary of the discrepancies found.
  - The original DDL from the `.sql` file.
  - A formatted version of the SXML, with comments indicating which columns are missing from the DDL.

-----

## Usage and Safety

### How to Run

Before executing the script, you must specify the folder you want to scan. Open the Python script and modify the `target_directory` variable near the bottom of the file:

```python
if __name__ == "__main__":
    # --- IMPORTANT ---
    # Change this path to the folder you want to scan.
    target_directory = "./your_sql_folder" 
    
    # ... rest of the script
```

### **Use Git\!**

It is **highly recommended** that you run this script on a project that is under version control (e.g., Git). This allows you to easily review all changes made by the script and discard them if anything looks incorrect.

```bash
# After running the script, check the changes
git status
git diff

# If the changes are not what you expected, you can easily revert them
git restore .
```

### Disclaimer

This script was generated with the assistance of Google's Gemini. While it has been tested and works for the specific use case it was designed for, it is not an official or professionally supported tool.

**Use it at your own risk.** Always back up your files and review the changes made by the script before committing them to your project.
