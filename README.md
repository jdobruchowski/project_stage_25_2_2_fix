# SQLcl Snapshot Validator and Fixer

## Purpose

This script is a utility designed to analyze, validate, and automatically correct a  range of  issues found in SQL files generated by the Oracle SQLcl `project export` command in version 25.2.x It ensures that the SQL Data Definition Language (DDL) and the embedded SXML metadata are consistent, clean, and not failing

## Key Features

1.  **SXML Metadata Correction**:
    *   **Fixes Malformed XML**: Automatically repairs SXML where a closing `</IDENTITY_COLUMN>` tag is missing.
    *   **Enforces `NOT NULL` on ID**: Ensures the `ID` identity column has the corresponding `NOT NULL` property in the SXML.
    *   **Resets Identity Start Value**: Optionally resets any identity column's `START WITH` value in the SXML to `1` . This causes the project stage command to actually work!

2.  **DDL and SXML Synchronization**:
    *   **Adds Missing Columns**: If a column exists in the `CREATE TABLE` statement but is missing from the SXML, the script automatically generates and inserts the correct XML block.
    *   **Matches Column Order**: Reorders the columns within the SXML to exactly match the order in the DDL, eliminating a common source of "false positive" changes in version control.
    *   **Validates Column Attributes**: Performs a detailed comparison of columns, checking for mismatches in data type, length/precision, and nullability.

3.  **Automated `git diff` Noise Reduction**:
    *   After making corrections, the script performs a `git diff` and can automatically resolve trivial differences.
    *   **Ignores Cosmetic Changes**: If the only change is whitespace within the SXML, it reverts the SXML to match the version in the repo, ignoring the change.
    *   **Fixes Newline Issues**: Automatically fixes the common `\ No newline at end of file` warning from Git.

4.  **Comprehensive Logging and Reporting**:
    *   For any file that is modified or has discrepancies, it generates a detailed `.log` file.
    *   The log contains a summary of all fixes applied, the original DDL, a pretty-printed view of the SXML *before* and *after* changes, and the final `git diff` output.

## How It Works

The script will:
1.  Clean up any old `.log` files from previous runs.
2.  Traverse a specified folder and its subfolders, looking for `.sql` files.
3.  For each file, read the DDL and the `-- sqlcl_snapshot` line.
4.  Perform a series of validation and correction steps in a specific order (e.g., fix broken XML, add missing columns, reset identity, reorder columns).
5.  Save any changes to the file.
6.  Run `git diff` against a specified branch to check for meaningful changes.
7.  Attempt to fix trivial git "noise" (cosmetic SXML changes, newlines).
8.  If any changes were made or discrepancies remain, generate a detailed `.log` file for review.

## Usage and Safety

### Configuration File (`config.cfg`)

For convenience, you can set default values in a `config.cfg` file placed in the same directory as `main.py`. The script will automatically use these values unless they are overridden by command-line arguments.

**Example `config.cfg`:**
```ini
[settings]
# One or more root folders to scan for .sql files.
# Multiple directories can be specified, separated by commas.
target_directory = /path/to/dir1, /path/to/dir2, /path/to/dir3

# Set to 'true' to reset START_WITH values, 'false' otherwise.
reset_start_with = true

# The default git branch to compare against.
repo = main
```

## How to Run

The script is run from the command line. It determines which folders to scan based on the following order of precedence:

1.  One or more directory paths provided as command-line arguments.
2.  The `target_directory` value specified in `config.cfg` (supports multiple, comma-separated directories).

**Syntax:**
```bash
python main.py [target_directory ...] [--reset-start-with | --no-reset-start-with] [--repo <branch_name>]
```

**Arguments:**
*   `<target_directory ...>`: (Required) One or more paths to folders you want to scan. You can specify multiple directories separated by spaces.
*   `--reset-start-with`: (Optional) If present, resets all `START WITH` values in identity columns to 1.
*   `--repo <branch_name>`: (Optional) The name of the git branch to compare against. Defaults to `main`.

**Examples:**

```bash
# Scan multiple directories with default options
python main.py /path/to/dir1 /path/to/dir2 /path/to/dir3

# Scan multiple directories, reset identity columns, and compare against the 'develop' branch
python main.py ./sql_files ./other_sql --reset-start-with --repo develop
```

### **Use Git\!**

It is **highly recommended** that you run this script on a project that is under version control (e.g., Git). This allows you to easily review all changes made by the script and discard them if anything looks incorrect.

```bash
# After running the script, check the changes
git status
git diff

# If the changes are not what you expected, you can easily revert them
git restore .
```

### Disclaimer

This script was generated with the assistance of Google's Gemini. While it has been tested and works for the specific use case it was designed for, it is not an official or professionally supported tool.

**Use it at your own risk.** Always back up your files and review the changes made by the script before committing them to your project.
